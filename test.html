<html>
<head>
<script type="text/javascript" src="postMessageYield.js"></script>
<script type="text/javascript" src="vizLogger.js"></script>
</head>
<body>
    <h1>JS Thread slowdown test page</h1>
    <p>Refresh the page if you want to try a different type, it logs out to console</p>
    <label>Generated by</label>
    <select id="gen">
        <option>Websocket</option>
        <option>SetInterval</option>
    </select>

    <label>Yield Method</label>
    <select id="yield">
        <option>setTimeout</option>
        <option>setTimeoutTwice</option>
        <option>postMessage</option>
        <option>requestAnimationFrame</option>
    </select>

    <button onclick="go()">Go</button>
    <div id="output">
    </div>
    <script>
        var count = 0;
        var yieldMethod;

        function go(){
            var gen = document.getElementById("gen").value;
            var yieldSelection = document.getElementById("yield").value;

            yieldMethod = methods[yieldSelection]

            if(gen == "Websocket"){
                var url = "ws://localhost:8001"
                var ws = new WebSocket(url);
                var opened = false;
                ws.onopen = function()
                {
                    startTime = Date.now();
                    opened = true;
                    console.log("Connected...");
                };
                ws.onmessage = function (evt) 
                { 
                    doYield();
                };
                ws.onclose = function()
                { 
                    if(opened){
                        console.log("Connection is closed...");     
                    } else {
                        console.log("Couldn't make a connection to " + url + " :("); 
                    }
                    
                };
            } else {
                startTime = Date.now();
                setInterval(doYield, 3); // Msg every 3ms
            }
        }

        function doYield(){
            yieldMethod.call();
        }

        function timeout(){
            setTimeout(msgReceived, 0);
        }

        function setTimeoutTwice(){
            setTimeout(timeout, 0);
        }

        function postMessageCaller(){
            window.postMessageYield(msgReceived); 
        }

        var methods = {
            "postMessage": postMessageCaller,
            "setTimeout": timeout,
            "setTimeoutTwice": setTimeoutTwice
        };

        function msgReceived(){
            count++;
            if (count % 1000 == 0){
                var time = (Date.now() - startTime) / 1000;
                console.log("1000 msgs in " + time + " secs");    
                count = 0;
                startTime = Date.now();
            }
        }

        
    </script>
</body>
</html>